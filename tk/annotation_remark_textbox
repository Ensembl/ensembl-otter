#!/usr/local/bin/perl -w

### annotation_remark_textbox

use strict;
use CanvasWindow;

{
    my $widget = CanvasWindow::MainWindow->new('Annotation Remarks');

    my $std_border = 3;
    my $frame = $widget->Frame(
        -border => $std_border,
        )->pack(-side => 'top');
    my $label_switch_frame = $frame->Frame(
        -border => $std_border,
        )->pack(
            -side => 'left',
            -expand => 1,
            -fill => 'y',
            );
    
    my @label_pack = (-side => 'top', -expand => 1, -fill => 'x');
    my @label_anchor = (-padx => $std_border, -anchor => 'w');
    my $text_label = $label_switch_frame->Label(
        -text   => "Remarks:",
        @label_anchor,
        )->pack(@label_pack);

    my $ann_tag = 'annotation';

    # Button for setting Visible/annotation remarks
    my @annotation_color = (-foreground => 'white', -background => 'IndianRed3');
    my $annotation_button = $label_switch_frame->Button(
        -text   => $ann_tag,
        @label_anchor,
        @annotation_color,
        -activeforeground => 'white',
        -activebackground => 'IndianRed2',
        )->pack(@label_pack);

    my $text = $frame->Scrolled('Text',
        -scrollbars         => 'e',
        -width              => 30,
        -height             => 4,
        -exportselection    => 1,
        -background         => 'white',
        -wrap               => 'word',
        );
    $text->pack(-side => 'left');
    $text->tagConfigure($ann_tag, @annotation_color);
    $text->tagLower($ann_tag, 'sel');

    my $tw = $text->Subwidget('text');
    $tw->bind(ref($tw), '<Key>', '');
    $tw->bind("<Key>", [\&insert_char, Tk::Ev('A')]);

    #my $class = ref($text->Subwidget('text'));
    #foreach my $sequence ($text->bind($class)) {
    #    if ($sequence =~ /Key/) {
    #        print STDERR "seq=$sequence\n";
    #        #$text->bind($class, $sequence, '');
    #    } else {
    #        print STDERR "non-key=$sequence\n";
    #    }
    #}

    
    $annotation_button->configure(-command => sub {
        my ($line) = $text->index('insert') =~ /^(\d+)/;
        my $line_start = "$line.0";
        my @this_line = ("$line_start", "$line_start lineend");
        #warn "line start = $line_start";
        my $annotation_is_set = 0;
        foreach my $tag ($text->tagNames("$line_start")) {
            $annotation_is_set = 1 if $tag eq $ann_tag;
            $text->tagRemove($tag, @this_line);
        }
        unless ($annotation_is_set) {
            $text->tagAdd($ann_tag, @this_line);
        }
    });
    
    my $button_frame = $widget->Frame->pack(-side => 'top');
    $button_frame->Button(
        -text => 'Get remarks',
        -command => sub {
                my %ann_index = $text->tagRanges($ann_tag);
                my $line = 0;
                foreach my $string (split /\n/, $text->get('1.0', 'end')) {
                    $line++;
                    # Trim trailing spaces and full-stops from remark
                    $string =~ s/[\s\.]+$//;
                    next if $string eq '';
                    my $type = $ann_index{"$line.0"} ? 'Annotation_remark' : 'Remark';
                    print STDERR "$type: '$string'\n";
                }
            },
        )->pack(-side => 'left');

    $text->insert('1.0', "Line 1\nLine second is a really long line that will wrap\nLine the third\n");

    Tk::MainLoop();
}

# Inserts (printing) characters with the same style as the rest of the line
sub insert_char {
    my( $text, $char ) = @_;
    
    # We only want to insert printing characters in the Text box!
    # [:print:] is the POSIX class of printing characters.
    return unless $char =~ /[[:print:]]/;
    
    # Expected behaviour is that any selected text will
    # be replaced by what the user types.
    $text->deleteSelected;
    
    # There will only ever be one or zero tags per line in out Text box.
    my ($tag) = $text->tagNames('insert linestart');
    $text->insert('insert', $char, $tag);
}

__END__

=head1 NAME - annotation_remark_textbox

=head1 AUTHOR

James Gilbert B<email> jgrg@sanger.ac.uk

