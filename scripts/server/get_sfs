#!/usr/local/bin/perl5.8.0 -w

my $enshead = $ENV{ENSHEAD}; # is set by the server for any GET request

use strict;
use OtterDefs;
use CGI;
use Bio::Otter::ServerSide (':all');
use Bio::Otter::Lace::PipelineDB;
use Bio::EnsEMBL::DBSQL::DBAdaptor;
use Bio::Otter::DBSQL::DBAdaptor;
use Bio::Otter::Lace::ViaText ('%OrderOfOptions');

$| = 1;

my $cgi = new CGI;
set_nph($cgi);
my %cgi_args = $cgi->Vars;

my $analysis = $cgi_args{analysis};

my $odb = get_DBAdaptor_from_CGI_species($cgi, $OTTER_SPECIES, $enshead);
my ($pdb, $pipeline_slice, $pipe_connparms) = get_pipeline_adaptor_slice_parms($cgi, $odb, $enshead);

my @sf_optnames = @{ $OrderOfOptions{SimpleFeature} };

    # Fetch the features:
my $sf_adaptor = $pdb->get_SimpleFeatureAdaptor();
my $sfs = $sf_adaptor->fetch_all_by_Slice($pipeline_slice, $analysis);

print STDERR "Total of ".scalar(@$sfs)." $analysis simple features found\n";

my $output_string = '';

foreach my $sf (@$sfs) {
        # output a SimpleFeature line
    my @sf_optvalues = ('SimpleFeature');
    for my $opt (@sf_optnames) {
        push @sf_optvalues, $sf->$opt();
    }

    $output_string .= join("\t", @sf_optvalues)."\n";
}

send_response($cgi, $output_string, 1);

